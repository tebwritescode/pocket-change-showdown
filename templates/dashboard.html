{% extends "base.html" %}

{% block title %}Dashboard - PCS Tracker{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-pie"></i> Analytics Dashboard</h2>
                <div class="d-flex gap-2 align-items-center">
                    <select id="periodFilter" class="form-select" style="width: auto; display: inline-block;">
                        <option value="week" {% if period == 'week' %}selected{% endif %}>Last 7 Days</option>
                        <option value="month" {% if period == 'month' %}selected{% endif %}>Last 30 Days</option>
                        <option value="quarter" {% if period == 'quarter' %}selected{% endif %}>Last 90 Days</option>
                        <option value="year" {% if period == 'year' %}selected{% endif %}>Last Year</option>
                    </select>
                    <a href="{{ url_for('dashboard_customize') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-cog"></i> Customize
                    </a>
                    <a href="{{ url_for('report_config') }}" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Total Spent</h6>
                            <h3 class="mb-0">${{ total_expenses|currency }}</h3>
                        </div>
                        <div class="text-primary">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Expense Count</h6>
                            <h3 class="mb-0">{{ expense_count }}</h3>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-receipt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Average Expense</h6>
                            <h3 class="mb-0">${{ avg_expense|currency }}</h3>
                        </div>
                        <div class="text-info">
                            <i class="fas fa-calculator fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Period</h6>
                            <h3 class="mb-0">{{ period|title }}</h3>
                        </div>
                        <div class="text-warning">
                            <i class="fas fa-calendar-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Expenses by Category</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Payment Methods</h5>
                </div>
                <div class="card-body">
                    <canvas id="paymentChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Spending Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top Categories</h5>
                </div>
                <div class="card-body">
                    <div id="topCategoriesTable"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Period filter change handler
    document.getElementById('periodFilter').addEventListener('change', function() {
        window.location.href = '{{ url_for("dashboard") }}?period=' + this.value;
    });

    // Fetch and display chart data
    fetch('{{ url_for("api_expense_data") }}?period={{ period }}')
        .then(response => response.json())
        .then(data => {
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: data.categories.labels,
                    datasets: [{
                        data: data.categories.data,
                        backgroundColor: [
                            '#0d6efd', '#28a745', '#dc3545', '#ffc107', 
                            '#17a2b8', '#6f42c1', '#fd7e14', '#20c997',
                            '#e83e8c', '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = '$' + context.parsed.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Payment Method Chart
            const paymentCtx = document.getElementById('paymentChart').getContext('2d');
            new Chart(paymentCtx, {
                type: 'bar',
                data: {
                    labels: data.payment_methods.labels,
                    datasets: [{
                        label: 'Amount',
                        data: data.payment_methods.data,
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    }
                }
            });

            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: data.daily_trend.labels,
                    datasets: [{
                        label: 'Daily Spending',
                        data: data.daily_trend.data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Spent: $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    }
                }
            });

            // Top Categories Table
            if (data.categories.labels.length > 0) {
                let tableHtml = '<table class="table table-hover">';
                tableHtml += '<thead><tr><th>Category</th><th>Amount</th><th>Percentage</th></tr></thead>';
                tableHtml += '<tbody>';
                
                const total = data.categories.data.reduce((a, b) => a + b, 0);
                const sorted = data.categories.labels
                    .map((label, i) => ({ label: label, value: data.categories.data[i] }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 5);
                
                sorted.forEach(item => {
                    const percentage = ((item.value / total) * 100).toFixed(1);
                    tableHtml += `<tr>
                        <td>${item.label}</td>
                        <td>$${item.value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" style="width: ${percentage}%">${percentage}%</div>
                            </div>
                        </td>
                    </tr>`;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('topCategoriesTable').innerHTML = tableHtml;
            } else {
                document.getElementById('topCategoriesTable').innerHTML = '<p class="text-muted">No data available for the selected period.</p>';
            }
        })
        .catch(error => console.error('Error fetching chart data:', error));
});
</script>
{% endblock %}