{% extends "base.html" %}

{% block title %}Login - Sales Tracker{% endblock %}

{% block content %}
<style>
    /* Full screen login background */
    .login-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--info-color) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    /* Moving login box */
    .login-box {
        width: 300px;
        max-width: 85vw;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
        position: relative;
    }
    
    .login-button-container {
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .login-button-container.avoiding-mouse {
        z-index: 1001;
    }
    
    
    .login-header {
        background: linear-gradient(135deg, var(--primary-color), var(--info-color));
        color: white;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
        text-align: center;
        position: relative;
    }
    
    .login-body {
        padding: 1.5rem;
        position: relative;
    }
    
    
    .form-control-xl {
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        border-radius: 12px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .form-control-xl:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        transform: translateY(-2px);
    }
    
    .btn-xl {
        padding: 1rem 2rem;
        font-size: 1.2rem;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: linear-gradient(135deg, var(--primary-color), var(--info-color));
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-xl:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(13, 110, 253, 0.3);
    }
    
    .btn-xl:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .permission-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .permission-item {
        padding: 1rem;
        background: rgba(var(--bs-primary-rgb), 0.1);
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .permission-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .demo-link {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1001;
    }
    
    .floating-icon {
        position: absolute;
        color: rgba(255, 255, 255, 0.3);
        font-size: 2rem;
        animation: float 6s ease-in-out infinite;
    }
    
    .floating-icon:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
    .floating-icon:nth-child(2) { top: 20%; right: 15%; animation-delay: 1s; }
    .floating-icon:nth-child(3) { bottom: 30%; left: 8%; animation-delay: 2s; }
    .floating-icon:nth-child(4) { bottom: 15%; right: 12%; animation-delay: 3s; }
    
    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(5deg); }
    }
    
    /* Dark theme adjustments */
    [data-theme="dark"] .login-box {
        background: rgba(34, 34, 34, 0.95);
        color: var(--text-color);
    }
    
    [data-theme="dark"] .permission-item {
        background: rgba(255, 255, 255, 0.1);
    }
</style>

<div class="login-container">
    <!-- Floating background icons -->
    <i class="fas fa-chart-line floating-icon"></i>
    <i class="fas fa-users floating-icon"></i>
    <i class="fas fa-dollar-sign floating-icon"></i>
    <i class="fas fa-trophy floating-icon"></i>
    
    <div class="login-box" id="loginBox">
        <div class="login-header">
            <h4><i class="fas fa-chart-line me-2"></i>Sales Tracker</h4>
        </div>
        
        <div class="login-body">
            <form method="POST" id="loginForm">
                {{ form.hidden_tag() }}
                
                <div class="mb-4">
                    {{ form.username.label(class="form-label fw-semibold") }}
                    {{ form.username(class="form-control form-control-xl", placeholder="Enter your username", id="usernameField") }}
                    {% if form.username.errors %}
                        <div class="text-danger small mt-2">
                            {% for error in form.username.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="mb-4">
                    {{ form.password.label(class="form-label fw-semibold") }}
                    {{ form.password(class="form-control form-control-xl", placeholder="Enter your password", id="passwordField") }}
                    {% if form.password.errors %}
                        <div class="text-danger small mt-2">
                            {% for error in form.password.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="d-grid mb-4" id="loginButtonContainer">
                    <button type="submit" class="btn btn-primary btn-xl" id="loginButton" disabled>
                        <i class="fas fa-sign-in-alt me-2"></i>Sign In
                    </button>
                </div>
            </form>
            
        </div>
    </div>
    
    <a href="{{ url_for('analytics') }}" class="btn btn-outline-light btn-lg demo-link">
        <i class="fas fa-eye me-2"></i>View Demo (Blurred)
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginBox = document.getElementById('loginBox');
    const loginButtonContainer = document.getElementById('loginButtonContainer');
    const usernameField = document.getElementById('usernameField');
    const passwordField = document.getElementById('passwordField');
    const loginButton = document.getElementById('loginButton');
    
    let isAvoidingMouse = false;
    let avoidanceTimeout = null;
    let mouseX = 0;
    let mouseY = 0;
    
    // Auto-focus username field
    usernameField.focus();
    
    // Check if both fields are filled
    function areFieldsFilled() {
        const hasUsername = usernameField.value.trim().length > 0;
        const hasPassword = passwordField.value.trim().length > 0;
        return hasUsername && hasPassword;
    }
    
    // Check field status and update UI
    function checkFields() {
        const bothFieldsFilled = areFieldsFilled();
        
        // Enable/disable login button
        loginButton.disabled = !bothFieldsFilled;
        
        // Update button container state
        if (bothFieldsFilled) {
            returnToCenter();
        }
    }
    
    // Return button to center smoothly
    function returnToCenter() {
        if (isAvoidingMouse) {
            isAvoidingMouse = false;
            loginButtonContainer.classList.remove('avoiding-mouse');
            loginButtonContainer.style.transform = 'translate(0, 0)';
        }
    }
    
    // Move button away from mouse
    function avoidMouse(mouseX, mouseY) {
        if (areFieldsFilled()) return; // Don't avoid if fields are filled
        
        isAvoidingMouse = true;
        loginButtonContainer.classList.add('avoiding-mouse');
        
        const buttonRect = loginButtonContainer.getBoundingClientRect();
        const buttonCenterX = buttonRect.left + buttonRect.width / 2;
        const buttonCenterY = buttonRect.top + buttonRect.height / 2;
        
        // Calculate direction away from mouse
        const deltaX = buttonCenterX - mouseX;
        const deltaY = buttonCenterY - mouseY;
        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        
        // Normalize and create avoidance vector
        const avoidanceDistance = 80; // pixels to move away
        const normalizedX = deltaX / distance;
        const normalizedY = deltaY / distance;
        
        const moveX = normalizedX * avoidanceDistance;
        const moveY = normalizedY * avoidanceDistance;
        
        // Add some constraints to keep button visible
        const maxMoveX = Math.min(Math.abs(moveX), 60);
        const maxMoveY = Math.min(Math.abs(moveY), 40);
        
        const finalMoveX = moveX > 0 ? maxMoveX : -maxMoveX;
        const finalMoveY = moveY > 0 ? maxMoveY : -maxMoveY;
        
        loginButtonContainer.style.transform = `translate(${finalMoveX}px, ${finalMoveY}px)`;
        
        // Clear any existing timeout
        if (avoidanceTimeout) {
            clearTimeout(avoidanceTimeout);
        }
        
        // Return to center after 2 seconds if still incomplete
        avoidanceTimeout = setTimeout(() => {
            if (!areFieldsFilled()) {
                returnToCenter();
            }
        }, 2000);
    }
    
    // Track mouse movement
    document.addEventListener('mousemove', function(e) {
        mouseX = e.clientX;
        mouseY = e.clientY;
    });
    
    // Handle mouse enter on login button
    loginButton.addEventListener('mouseenter', function(e) {
        if (!areFieldsFilled()) {
            avoidMouse(e.clientX, e.clientY);
        }
    });
    
    // Handle clicks on the login button when fields are empty
    loginButton.addEventListener('click', function(e) {
        if (!areFieldsFilled()) {
            e.preventDefault();
            e.stopPropagation();
            avoidMouse(e.clientX, e.clientY);
            
            // Add a little shake effect
            loginButtonContainer.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                loginButtonContainer.style.animation = '';
            }, 500);
        }
    });
    
    // Add event listeners for field changes
    usernameField.addEventListener('input', checkFields);
    passwordField.addEventListener('input', checkFields);
    
    // Handle Enter key in fields
    usernameField.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            passwordField.focus();
        }
    });
    
    passwordField.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !loginButton.disabled) {
            document.getElementById('loginForm').submit();
        }
    });
    
    // Add some visual feedback when fields are focused
    [usernameField, passwordField].forEach(field => {
        field.addEventListener('focus', function() {
            this.parentElement.style.transform = 'translateY(-2px)';
        });
        
        field.addEventListener('blur', function() {
            this.parentElement.style.transform = 'translateY(0)';
        });
    });
    
    // Initial check
    checkFields();
    
    // Clean up timeout when page is unloaded
    window.addEventListener('beforeunload', function() {
        if (avoidanceTimeout) {
            clearTimeout(avoidanceTimeout);
        }
    });
});
</script>

<style>
/* Add shake animation */
@keyframes shake {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    25% { transform: translate(-5px, -5px) rotate(-2deg); }
    50% { transform: translate(5px, -5px) rotate(2deg); }
    75% { transform: translate(-5px, 5px) rotate(-1deg); }
}
</style>
{% endblock %}